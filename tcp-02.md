# TCP 报文格式

### 消息传输的核心要素

* 寄件人与收件人信息
  - IP 地址
  - TCP(UDP)端口
  - HTTP Host/URI 等
* 物流订单号
  - IP 序列号
  - TCP 序列号
* 物流系统需求

### TCP 协议的任务

* 主机内的进程寻址
* 创建、管理、终止连接
* 处理并将字节（8bit）流打包成报文段（如 IP 报文）
* 传输数据
* 保持可靠性与传输质量
* 流控制与拥塞控制

### 如何标识一个连接？

* TCP 四元组（源地址，源端口，目的地址，目的端口）
  - 对于 IPv4 地址，单主机最大 TCP 连接数为 $2^{(32+16+32+16)}$
* 没有连接 ID：QUIC 协议

### TCP Segment 报文段

* 控制信息
  - 寻址
  - 滑动窗口
  - Flags
  - 校验和
* 数据

### 常用选项

| 类型 | 总长度（字节） | 数据             | 描述                      |
|----|---------|----------------|-------------------------|
| 0  | -       | -              | 选项列表末尾标识                |
| 1  | -       | -              | 无意义，用于 32 位对齐使用         |
| 2  | 4       | MSS 值          | 握手时发送端告知可以接收的最大报文段大小    |
| 3  | 3       | 窗口移位           | 指明最大窗口扩展后的大小            |
| 4  | 2       | -              | 表明支持 SACK 选择性确认中间报文段功能  |
| 5  | 可变      | 确认报文段          | 选择性确认窗口中间的 Segments 报文段 |
| 8  | 10      | Timestamps 时间戳 | 用于更精准的计算RTT，及解决 PAWS 问题 |
| 14 | 3       | 校验和算法          | 双方认可后，可使用新的校验和算法        |
| 15 | 可变      | 校验和            | 当 16 位标准校验和放不下时，放置在这里   |
| 34 | 可变      | FOC            | TFO中Cookie              |

> 此文章为 3 月 Day18 学习笔记，内容来源于极客时间[《Web 协议详解与抓包实战》](http://gk.link/a/11UWp)，强烈推荐该课程！
