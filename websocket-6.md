# WebSocket 会话心跳与会话关闭

## 如何保持会话心跳

### 心跳帧

* 心跳帧可以插在数据帧中传输
  - ping 帧
    - opcode=9
    - 可以含有数据
  - pong 帧
    - opcode=A
    - 必须与 ping 帧数据相同

## 如何关闭会话

### 关闭会话的方式

* 控制帧中的关闭帧：在 TCP 连接之上的双向关闭
  - 发送关闭帧后，不能再发送任何数据
  - 接收到关闭帧后，不再接收任何到达的数据
* TCP 连接意外中断

### 关闭帧格式

* opcode=8
* 可以含有数据，但仅用于解释关 闭会话的原因
  - 前 2 字节为无符号整型
  - 遵循 mask 掩码规则

### 关闭帧的错误码


| 错误码 | 含义                                  |
|-------|-------------------------------------|
| 1000 | 正常关闭                                |
| 1001 | 表示浏览器页面跳转或者服务器将要关机                  |
| 1002 | 发现协议错误                              |
| 1003 | 接收到不能处理的数据帧（例如某端不能处理二进制消息）          |
| 1004 | 预留                                  |
| 1005 | 预留（不能用在关闭帧里），期望但没有接收到错误码            |
| 1006 | 预留（不能用在关闭帧里），期望给出非正常关闭的错误码          |
| 1007 | 消息格式不符合 opcode（例如文本帧里消息没有用 UTF8 编码） |
| 1008 | 接收到的消息不遵守某些策略（比 1003、1009 更一般的错误）   |
| 1009 | 消息超出能处理的最大长度                        |
| 1010 | 客户端明确需要使用扩展，但服务器没有给出扩展的协商信息         |
| 1011 | 服务器遇到未知条件不能完成请求                     |
| 1015 | 预留（不能用在关闭帧里），表示 TLS 握手失败            |

> 此文章为 2 月 Day6 学习笔记，内容来源于极客时间[《Web 协议详解与抓包实战》](http://gk.link/a/11UWp)，强烈推荐该课程！
